From b9c97f81dfa8335745bdff3cc5c92aa0058f8c3a Mon Sep 17 00:00:00 2001
From: danielml <daniel@danielml.dev>
Date: Sat, 18 May 2024 15:00:36 +0200
Subject: [PATCH] drivers: input: xiaomi: Implement a double_tap node

Change-Id: I0bab4b469eb69083a202943998144ce68f583110
Signed-off-by: danielml <daniel@danielml.dev>

Source: https://github.com/LineageOS/android_kernel_xiaomi_sm6150/commit/b9c97f81dfa8335745bdff3cc5c92aa0058f8c3a
---
 .../input/touchscreen/xiaomi/xiaomi_touch.c   | 35 +++++++++++++++++++
 1 file changed, 35 insertions(+)

diff --git a/drivers/input/touchscreen/xiaomi/xiaomi_touch.c b/drivers/input/touchscreen/xiaomi/xiaomi_touch.c
index 76218483c351..7052d06c7f6d 100755
--- a/drivers/input/touchscreen/xiaomi/xiaomi_touch.c
+++ b/drivers/input/touchscreen/xiaomi/xiaomi_touch.c
@@ -214,6 +214,38 @@ int update_palm_sensor_value(int value)
 	return 0;
 }
 
+static unsigned int double_tap_status = 0;
+static ssize_t double_tap_show(struct device *dev,
+struct device_attribute *attr, char *buf)
+{
+	return snprintf(buf, PAGE_SIZE, "%d\n", double_tap_status);
+}
+
+static ssize_t double_tap_store(struct device *dev,
+struct device_attribute *attr, const char *buf, size_t count)
+{
+	unsigned int input;
+	struct xiaomi_touch_pdata *pdata = dev_get_drvdata(dev);
+	struct xiaomi_touch_interface *touch_data = pdata->touch_data;
+	int ret;
+
+	if (sscanf(buf, "%d", &input) < 0)
+			return -EINVAL;
+
+	if (touch_data->setModeValue) {
+		ret = touch_data->setModeValue(Touch_Doubletap_Mode, input);
+
+		if (!ret) {
+			double_tap_status = input;
+			MI_TOUCH_LOGI(1, "%s %s: set double tap to %d", MI_TAG, __func__, double_tap_status);
+		}
+	} else {
+		MI_TOUCH_LOGE(1, "%s %s: setModeValue not implemented", MI_TAG, __func__);
+	}
+
+	return count;
+}
+
 static ssize_t palm_sensor_show(struct device *dev,
 struct device_attribute *attr, char *buf)
 {
@@ -385,6 +417,8 @@ static ssize_t xiaomi_panel_display_show(struct device *dev, struct device_attri
 	return snprintf(buf, PAGE_SIZE, "%c\n", value);
 }
 
+static DEVICE_ATTR(double_tap, 0644, double_tap_show, double_tap_store);
+
 static DEVICE_ATTR(palm_sensor, (S_IRUGO | S_IWUSR | S_IWGRP),
 		   palm_sensor_show, palm_sensor_store);
 
@@ -400,6 +434,7 @@ static DEVICE_ATTR(panel_vendor, 0644, xiaomi_panel_vendor_show, NULL);
 static DEVICE_ATTR(panel_color, 0644, xiaomi_panel_color_show, NULL);
 
 static struct attribute *touch_attr_group[] = {
+	&dev_attr_double_tap.attr,
 	&dev_attr_palm_sensor.attr,
 	&dev_attr_p_sensor.attr,
 	&dev_attr_log_debug.attr,
