# Maintainer: WeirdTreeThing <bradyn127@protonmail.com>
# Co-Maintainer: lognoserob <longnoserob@postmarketos.org.
pkgname=linux-postmarketos-mediatek-mt81
pkgver=6.12.9
pkgrel=0
pkgdesc="Mainline kernel for Mediatek mt81XX (83..99)"
arch="aarch64"
_flavor="${pkgname#linux-}"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps
	pmb:cross-native
	pmb:kconfigcheck-community
	"
makedepends="
	bison
	devicepkg-dev
	findutils
	flex
	postmarketos-installkernel
	openssl-dev
	perl
	rsync
	gzip
	xz
	gmp-dev
	mpc1-dev
	mpfr-dev
	lz4
	zstd
"
replaces="linux-postmarketos-mediatek-mt8183 linux-postmarketos-mediatek-mt81xx"

_carch="arm64"

# Source
_config="config-$_flavor.$CARCH"
case $pkgver in
	*.*.*)	_kernver=${pkgver%.0};;
	*.*)	_kernver=$pkgver;;
esac

source="
	https://cdn.kernel.org/pub/linux/kernel/v${_kernver%%.*}.x/linux-$_kernver.tar.xz
        0001-arm64-dts-mediatek-Add-dts-for-hayato-rev5-sku0.patch
	arm64-dts-mt8183-Add-kukui-jacuzzi-cerise-board.patch
	mt8183-kukui-jacuzzi-fix-display-resume.patch
	mt8183-kukui-jacuzzi-hack-dpms-resume.patch
	mt8183-fix-bluetooth.patch
	mt8183-kukui-jacuzzi-fennel14-rt1015p-sound.patch
	mt8195-adsp.patch
	mt8195-cherry-tomato-NVMe.patch
	mt8195-dvfsrc.patch
	config-$_flavor.aarch64
"
builddir="$srcdir/linux-$_kernver"

prepare() {
	default_prepare
	cp "$srcdir/config-$_flavor.$CARCH" .config
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-$_flavor"
}

package() {
	mkdir -p "$pkgdir"/boot

	make zinstall modules_install dtbs_install \
		ARCH="$_carch" \
		INSTALL_PATH="$pkgdir"/boot \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs
	rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

	install -D "$builddir"/include/config/kernel.release \
		"$pkgdir"/usr/share/kernel/$_flavor/kernel.release
}


sha512sums="
3538c19b22f1810849e01ad7005f39b0c4e1e2de99f3168bb6a35ad9d51d7ec7b22a8203890e7b073bff83951f930245d5857a86cef80454800136a53047ff37  linux-6.12.9.tar.xz
bf39ed6646a869a7a99dc7f0ccc7bbaca0c50776e87848cb1a9e55bef317a73c08549a9acb8cce5c394ab3bf90667e4d1cf8a3671bb9de15d2a470d5e8be0261  0001-arm64-dts-mediatek-Add-dts-for-hayato-rev5-sku0.patch
a95ce4a71d249ef401ca04cf8faf85b9022114d35fef5a0ce18929f734a0ac80ed0332648cc9768625f3c26b3720679e1a20bf8ac564087bd4c64f49cd96cc45  arm64-dts-mt8183-Add-kukui-jacuzzi-cerise-board.patch
519b6468bca78d0e315c826592ae40dddca9daeba7c2b451a20ca996494cca45721833b9138fefbb543f53e0b9257c78ec4fec54de2a160aa8df730daf3ac996  mt8183-kukui-jacuzzi-fix-display-resume.patch
e9a128a8ddd98c6c8957ba45186afa2ea8ebeac83d4f2db3ff9ee8a5dd8027af90868c334a7b456bfe7dce793517f27ad63efa220bc933e3407f6362da6d7b2a  mt8183-kukui-jacuzzi-hack-dpms-resume.patch
d74da1231181835bec82015da1b3f5b08a1fe9c3c35dd712e285891094d94d9427ceac75d32f74be3a635e17d93ad82b37adf97db8176efc91aed17535023fc2  mt8183-fix-bluetooth.patch
9b8707de42635734031495da055c5860addeb656051540f1a14404b10aa8b501168d8b0e274b37bce989db3bc050e9beef722189556f6d782b92cc907731488d  mt8183-kukui-jacuzzi-fennel14-rt1015p-sound.patch
7582a86506ec1ff0a08ae52d249fa465f436439b01b592fe01f7aaa2fbdb3b2ae989473cd5cd9d39e6e9dac60d847063fa66ef36b808be695aa62b512d722d2b  mt8195-adsp.patch
1e0eae8743a8c6128f18ae7f5b843918480b32470e9766809f18c2029aeaa56d40c86afc3f5e2db0e2e63a2c76ab976a2ecc7b7b862caaa18e289be6b94998ba  mt8195-cherry-tomato-NVMe.patch
c61890785079aa67a4b92a30955cc7b2b1e1f8460255f2391b3d11f76c0e9568fe7dc9710e542392d42bf0a4426e1d47d7287621166e0cc9aa0333382ebd2cd2  mt8195-dvfsrc.patch
ffb0a9f85dd4dda72dd5683ea4f9fb6fad3f876224555ef8bbe144d6011b99a922814f7771f0e2cae72aad47f751d3422670352daf86405814a34694fefe67f9  config-postmarketos-mediatek-mt81.aarch64
"
